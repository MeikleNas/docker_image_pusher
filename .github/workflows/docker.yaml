name: Docker

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 21,9 * * *'  # 镜像推送：北京时间 5:00 和 17:00
    - cron: '0 0 1 * *'     # 记录清理：每月1号 UTC 0点（北京时间8点）

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  build:
    name: Pull and Push Image
    runs-on: ubuntu-latest
    steps:
    - name: Before freeing up disk space
      run: |
        echo "Before freeing up disk space"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Deep clean disk space
      run: |
        echo "===== 开始深度清理磁盘空间 ====="
        sudo apt-get autoremove -y --purge
        sudo apt-get clean -y
        sudo apt-get autoclean -y
        sudo journalctl --vacuum-size=50M
        sudo rm -rf /var/log/*.gz /var/log/*.old /var/log/*.[0-9]
        sudo truncate -s 0 /var/log/syslog /var/log/auth.log /var/log/daemon.log 2>/dev/null
        sudo rm -rf /home/runner/actions-runner/_work/_temp/*
        sudo rm -rf /home/runner/actions-runner/_work/_artifact/*
        sudo rm -rf /home/runner/.cache/* /home/runner/.npm /home/runner/.yarn
        sudo rm -rf /tmp/* /var/tmp/* /usr/local/lib/android /opt/ghc /usr/share/dotnet
        sudo docker system prune -af --volumes
        sudo docker volume prune -af
        sudo docker image prune -af
        echo "===== 深度清理完成 ====="
        df -hT

    - name: Free up disk space complete
      run: |
        echo "Free up disk space complete"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push image Aliyun
      run: |
        if [ -z "$ALIYUN_REGISTRY" ] || [ -z "$ALIYUN_NAME_SPACE" ] || [ -z "$ALIYUN_REGISTRY_USER" ] || [ -z "$ALIYUN_REGISTRY_PASSWORD" ]; then
            echo "ERROR: 阿里云仓库密钥未配置完整！"
            exit 1
        fi

        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY
        if [ $? -ne 0 ]; then
            echo "ERROR: Docker登录失败！"
            exit 1
        fi

        if [ ! -f "images.txt" ]; then
            echo "ERROR: images.txt文件不存在！"
            exit 1
        fi
        echo "===== images.txt 内容 ====="
        cat images.txt
        echo "==========================="

        declare -A duplicate_images
        declare -A temp_map
        while IFS= read -r line || [ -n "$line" ]; do
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi
            
            image=$(echo "$line" | awk '{print $NF}')
            image="${image%%@*}"
            [ -z "$image" ] && continue
            
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            name_space=$(echo "$image" | awk -F'/' '{if (NF>=2) print $(NF-1); else print ""}')
            name_space="${name_space}_"
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
            
            if [[ -n "${temp_map[$image_name]}" ]]; then
                if [[ "${temp_map[$image_name]}" != "$name_space" ]]; then
                    echo "注意：镜像名重名 - $image_name"
                    duplicate_images[$image_name]="true"
                fi
            else
                temp_map[$image_name]="$name_space"
            fi       
        done < images.txt
        
        while IFS= read -r line || [ -n "$line" ]; do
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi
        
            echo "===== 处理镜像: $line ====="
            docker pull "$line" || { echo "WARN: 拉取镜像 $line 失败，跳过"; continue; }
            
            platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
            platform_prefix=""
            if [ -n "$platform" ]; then
                platform_prefix="${platform//\//_}_"
            fi
            
            image=$(echo "$line" | awk '{print $NF}')
            image="${image%%@*}"
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            name_space=$(echo "$image" | awk -F'/' '{if (NF>=2) print $(NF-1); else print ""}')
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
            
            name_space_prefix=""
            if [[ -n "${duplicate_images[$image_name]}" && -n "$name_space" ]]; then
                name_space_prefix="${name_space}_"
            fi
            
            new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$platform_prefix$name_space_prefix$image_name_tag"
            echo "打标签: $image → $new_image"
            docker tag "$image" "$new_image" || { echo "WARN: 打标签失败，跳过"; continue; }
            
            echo "推送镜像: $new_image"
            docker push "$new_image" || { echo "WARN: 推送镜像失败，跳过"; }
            
            echo "清理镜像: $image 和 $new_image"
            docker rmi "$image" 2>/dev/null
            docker rmi "$new_image" 2>/dev/null
            
            echo "===== 当前磁盘空间 ====="
            df -hT
            echo "=========================="
        done < images.txt

    - name: Final clean disk space
      if: always()
      run: |
        echo "===== 最终兜底清理 ====="
        sudo docker system prune -af --volumes
        sudo rm -rf /home/runner/.cache/* 2>/dev/null
        df -hT

  clean-old-runs:
    name: Clean Old Workflow Runs
    runs-on: ubuntu-latest
    # 修复：支持手动触发 + 每月定时触发
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && github.event.schedule == '0 0 1 * *')
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10
          delete_workflow_pattern: "Docker"
          skip_complete_runs: false
